<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node Nav</title>
    <link rel="stylesheet" href="css/index.css">
</head>
<body>

    <div id="global-loader">
        <div class="loader-spinner"></div>
    </div>

    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <span>âš¡</span> Node Nav
        </a>
        <div class="nav-categories" id="nav-categories"></div>
        <a href="/login" class="btn-login">ç™»å½•</a>
    </nav>

    <div class="bookmarks-section search-bar-wrapper">
        <div class="search-bar-container">
            <h1 class="main-title" id="site-main-title">Node Nav</h1>
            
            <form id="search-form" class="search-form" action="https://www.google.com/search" method="get" target="_blank">
                <input type="text" name="q" id="search-input" class="search-input" placeholder="æœç´¢ä¹¦ç­¾æˆ– Google æœç´¢..." autocomplete="off">
                <button type="submit" class="search-button">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </button>
            </form>
            </div>
    </div>

    <div class="bookmarks-section" id="bookmarks-container">
    </div>

    <script>
        let allBookmarksData = {};
        let flatBookmarksList = []; 
        let currentCategory = ''; 
        let menuHideTimer = null; 

        const folderIconSvg = `<svg class="category-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;

        function applyTheme(mode) {
            let isDark = false;
            if (mode === 'auto') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    isDark = true;
                }
            } else if (mode === 'dark') {
                isDark = true;
            }

            if (isDark) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
        }
        
        // ======================================
        // =========== æœç´¢é€»è¾‘ (ç®€åŒ–ç‰ˆ) =========
        // ======================================
        
        function searchBookmarks(query) {
            // 1. å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¢å¤å½“å‰åˆ†ç±»æ˜¾ç¤º
            if (!query || query.length < 1) {
                switchCategory(currentCategory); 
                return;
            }

            const lowerCaseQuery = query.toLowerCase();

            // 2. æœç´¢é€»è¾‘
            const results = flatBookmarksList.filter(item => 
                (item.name && item.name.toLowerCase().includes(lowerCaseQuery)) ||
                (item.url && item.url.toLowerCase().includes(lowerCaseQuery))
            );

            // 3. ä»…æ›´æ–°ä¸»ç•Œé¢ç½‘æ ¼
            renderBookmarksGrid(results, query);
        }

        // ======================================
        // ======================================


        async function initApp() {
            const container = document.getElementById('bookmarks-container');
            const loader = document.getElementById('global-loader'); 
            const mainTitle = document.getElementById('site-main-title');
            
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            
            try {
                const response = await fetch('/api/bookmarks');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                allBookmarksData = data;

                flatBookmarksList = [];
                const ignoredKeysForFlatList = ['categories', 'adminAvatar', 'password', 'settings'];
                Object.keys(allBookmarksData).forEach(category => {
                    if (!ignoredKeysForFlatList.includes(category) && Array.isArray(allBookmarksData[category])) {
                        allBookmarksData[category].forEach(bookmark => {
                            flatBookmarksList.push({
                                ...bookmark,
                                categoryName: category 
                            });
                        });
                    }
                });

                const siteTitle = (allBookmarksData.settings && allBookmarksData.settings.siteTitle) ? allBookmarksData.settings.siteTitle : 'Node Nav';
                document.title = siteTitle;
                
                const brandLink = document.querySelector('.navbar-brand');
                if (brandLink) {
                    const iconSpan = brandLink.querySelector('span'); 
                    brandLink.innerHTML = ''; 
                    if(iconSpan) brandLink.appendChild(iconSpan); 
                    brandLink.append(' ' + (siteTitle || 'Node Nav'));
                }
                
                if (mainTitle) {
                    mainTitle.textContent = siteTitle;
                }

                const themeSetting = (allBookmarksData.settings && allBookmarksData.settings.theme) ? allBookmarksData.settings.theme : 'auto';
                applyTheme(themeSetting);
                
                const navContainer = document.getElementById('nav-categories');
                navContainer.innerHTML = '';
                
                const ignoredKeys = ['categories', 'adminAvatar', 'password', 'settings'];
                const rawKeys = Object.keys(allBookmarksData).filter(key => 
                    !ignoredKeys.includes(key) && Array.isArray(allBookmarksData[key])
                );

                const groups = {}; 
                rawKeys.forEach(key => {
                    const rootName = key.includes(' / ') ? key.split(' / ')[0] : key;
                    if (!groups[rootName]) groups[rootName] = [];
                    groups[rootName].push(key);
                });

                let floatingMenu = document.getElementById('nav-floating-menu');
                if (!floatingMenu) {
                    floatingMenu = document.createElement('div');
                    floatingMenu.id = 'nav-floating-menu';
                    floatingMenu.className = 'nav-floating-menu';
                    document.body.appendChild(floatingMenu);
                    
                    floatingMenu.onmouseenter = () => {
                        if (menuHideTimer) clearTimeout(menuHideTimer);
                    };
                    floatingMenu.onmouseleave = () => {
                        menuHideTimer = setTimeout(() => {
                            floatingMenu.classList.remove('show');
                            document.querySelectorAll('.nav-dropdown-btn').forEach(b => b.classList.remove('open'));
                        }, 200);
                    };

                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.nav-dropdown-wrapper') && !e.target.closest('.nav-floating-menu')) {
                            floatingMenu.classList.remove('show');
                            document.querySelectorAll('.nav-dropdown-btn').forEach(b => b.classList.remove('open'));
                        }
                    });
                }

                let firstCategoryToRender = null;

                // --- æ¸²æŸ“å¯¼èˆªæŒ‰é’® ---
                Object.keys(groups).forEach(rootName => {
                    const subKeys = groups[rootName];
                    
                    if (subKeys.length === 1 && subKeys[0] === rootName) {
                        const btn = document.createElement('a');
                        btn.className = 'nav-category-link';
                        btn.href = 'javascript:void(0)';
                        btn.innerHTML = `${folderIconSvg}<span>${rootName}</span>`;
                        btn.dataset.group = rootName;
                        btn.onclick = (e) => {
                            const targetLink = e.target.closest('.nav-category-link');
                            if(targetLink) {
                                switchCategory(rootName);
                                highlightNav(targetLink);
                                if(searchInput) {
                                    searchInput.value = '';
                                }
                            }
                        };
                        navContainer.appendChild(btn);
                        if (!firstCategoryToRender) firstCategoryToRender = { type: 'link', el: btn, cat: rootName };
                    
                    } else {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'nav-dropdown-wrapper';

                        const btn = document.createElement('button');
                        btn.className = 'nav-dropdown-btn';
                        const arrowSvg = `<svg class="nav-arrow" viewBox="0 0 1024 1024" width="12" height="12"><path d="M858.9 352H165.1c-10.2 0-19.2 4.9-25.1 12.5-5.9 7.6-6.8 17.9-2.3 26.6l346.9 672.4c6.6 12.8 19.6 20.9 34 20.9s27.4-8.1 34-20.9l346.9-672.4c4.5-8.7 3.6-19-2.3-26.6-5.9-7.6-14.9-12.5-25.1-12.5z" fill="currentColor"/></svg>`;
                        btn.innerHTML = `${folderIconSvg}<span>${rootName}</span>${arrowSvg}`;
                        btn.dataset.group = rootName;
                        
                        btn.onclick = (e) => {
                            switchCategory(rootName);
                            btn.querySelector('span').innerText = rootName; 
                            highlightNav(btn);
                            floatingMenu.classList.remove('show');
                            btn.classList.remove('open');
                            if(searchInput) {
                                searchInput.value = '';
                            }
                        };

                        wrapper.onmouseenter = () => {
                            if (menuHideTimer) clearTimeout(menuHideTimer);
                            document.querySelectorAll('.nav-dropdown-btn').forEach(b => {
                                if (b !== btn) b.classList.remove('open');
                            });
                            btn.classList.add('open');
                            showFloatingMenu(btn, subKeys, rootName);
                        };

                        wrapper.onmouseleave = () => {
                            menuHideTimer = setTimeout(() => {
                                floatingMenu.classList.remove('show');
                                btn.classList.remove('open');
                            }, 200);
                        };
                        
                        wrapper.appendChild(btn);
                        navContainer.appendChild(wrapper);
                        if (!firstCategoryToRender) firstCategoryToRender = { type: 'dropdown', el: btn, cat: subKeys[0] };
                    }
                });

                if (firstCategoryToRender) {
                    if (firstCategoryToRender.type === 'link') {
                        firstCategoryToRender.el.click();
                    } else {
                        switchCategory(firstCategoryToRender.cat);
                        highlightNav(firstCategoryToRender.el);
                    }
                } else {
                    container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;">æš‚æ— æ•°æ®ã€‚</div>';
                }
            
            } catch (error) { 
                console.error('åŠ è½½å¤±è´¥:', error);
                container.innerHTML = `<p style="text-align:center; color:#999; margin-top:50px;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚</p>`;
            } finally {
                setTimeout(() => { if(loader) loader.classList.add('hidden'); }, 300);
            }

            if (searchForm && searchInput) {
                searchForm.addEventListener('submit', function(e) {
                    // å¦‚æœè¾“å…¥æ¡†æ²¡æœ‰å†…å®¹ï¼Œé˜»æ­¢æäº¤
                    if (!searchInput.value.trim()) {
                        e.preventDefault(); 
                    }
                });
                
                searchInput.addEventListener('input', function() {
                    searchBookmarks(this.value.trim());
                });

                searchInput.addEventListener('focus', function() {
                    if (this.value.trim()) {
                        searchBookmarks(this.value.trim());
                    }
                });
            }
        }

        function showFloatingMenu(triggerBtn, keys, rootName) {
            const menu = document.getElementById('nav-floating-menu');
            const rect = triggerBtn.getBoundingClientRect();
            
            menu.innerHTML = '';
            
            const subKeysOnly = keys.filter(key => key !== rootName);

            if (subKeysOnly.length === 0) return;

            subKeysOnly.forEach(key => {
                const item = document.createElement('div');
                item.className = 'nav-menu-item';
                const simpleName = key.split(' / ')[1];
                item.innerHTML = `${folderIconSvg}<span>${simpleName}</span>`;
                
                if (currentCategory === key) item.classList.add('active');

                item.onclick = () => {
                    switchCategory(key);
                    highlightNav(triggerBtn);
                    const textSpan = triggerBtn.querySelector('span');
                    if(textSpan) textSpan.innerText = simpleName;

                    menu.classList.remove('show');
                    triggerBtn.classList.remove('open');
                    
                    const searchInput = document.getElementById('search-input');
                    if(searchInput) {
                        searchInput.value = '';
                    }
                };
                menu.appendChild(item);
            });

            // å±…ä¸­å¯¹é½é€»è¾‘
            menu.style.visibility = 'hidden';
            menu.style.display = 'block';
            const menuWidth = menu.offsetWidth;
            const btnCenter = rect.left + (rect.width / 2);
            let leftPos = btnCenter - (menuWidth / 2);
            if (leftPos < 10) leftPos = 10;
            menu.style.left = `${leftPos}px`;
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.visibility = '';
            menu.style.display = ''; 
            requestAnimationFrame(() => {
                menu.classList.add('show');
            });
        }

        function highlightNav(targetEl) {
            document.querySelectorAll('.nav-category-link').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-btn').forEach(el => el.classList.remove('active'));
            if (targetEl) targetEl.classList.add('active');
        }

        // --- é€šç”¨æ¸²æŸ“å‡½æ•° ---
        function renderBookmarksGrid(items, emptyMsgStr) {
            const container = document.getElementById('bookmarks-container');
            container.innerHTML = ''; 
            
            if (items.length === 0) {
                 const msg = emptyMsgStr 
                    ? `æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¹¦ç­¾ï¼ŒæŒ‰å›è½¦å¯è¿›è¡Œ Google æœç´¢` 
                    : `æš‚æ— ä¹¦ç­¾`;
                 
                 container.innerHTML = `<div style="text-align:center; margin-top:40px; color:#999; font-size: 0.9em;">${msg}</div>`;
                 return;
            }

            const gridDiv = document.createElement('div');
            gridDiv.className = 'bookmark-grid';
            
            items.forEach(item => {
                const a = document.createElement('a');
                a.href = item.url;
                a.className = 'bookmark-card';
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                
                const iconHtml = item.icon 
                    ? `<img src="${item.icon}" alt="icon" class="bookmark-icon" onerror="this.onerror=null;this.src='https://www.google.com/s2/favicons?domain=google.com'">` 
                    : '<span>ğŸ”—</span>';
                
                let categoryTag = '';
                if (emptyMsgStr && item.categoryName) {
                    const simpleCat = item.categoryName.split(' / ').pop();
                    categoryTag = `<div style="font-size:10px; color:#999; margin-top:2px;">${simpleCat}</div>`;
                }

                a.innerHTML = `${iconHtml}<div class="bookmark-name" title="${item.name}">${item.name || 'æœªå‘½å'}</div>${categoryTag}`;
                gridDiv.appendChild(a);
            });
            container.appendChild(gridDiv);
        }

        function switchCategory(categoryName) {
            currentCategory = categoryName; 
            const items = Array.isArray(allBookmarksData[categoryName]) ? allBookmarksData[categoryName] : [];
            renderBookmarksGrid(items);
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
